#!/bin/bash
## Crafted (c) 2022 by Encora - We are stronger together
## Prepared : Roberto Nogueira
## File     : site
## Project  : rails-site-manager
## Reference: bash
## Depends  : fping, screen.
## Purpose  : Help to manage ordinary things.

# set -x

export SITE_VERSION=v1.0.00
export SITE_VERSION_DATE=2022.06.05
export SITE_UPDATE_MESSAGE=""

# git domains
domain(){
  local domain=$(echo $(git config user.email) | awk -F\@ '{print $2}' | awk -F\. '{print $1}')
  echo $domain
}
domain.methods(){ echo "help|encora|gmail"; }
domain.help(){ printf "\e[1;37m%s \e[0m \e[1;36m%s\e[0m\n" "domain" "[$(domain.methods)]"; }
domain.encora.init(){ encora_name=$1; encora_email=$2; }
domain.encora(){
  git config --global user.name "$encora_name"
  git config --global user.email "$encora_email"
}
domain.gmail.init(){ gmail_name=$1; gmail_email=$2; }
domain.gmail(){
  git config --global user.name "$gmail_name"
  git config --global user.email "$gmail_email"
}

#projects
_projects(){
  tl | sed 's/^/  /' 
}
projects.init(){ projects_print=$1; }
projects.methods(){ echo "help|ls|print"; }
projects.help(){ printf "\e[1;37m%s \e[0m \e[1;36m%s\e[0m\n" "projects" "[$(projects.methods)]"; }
projects.ls(){ tdpl; }
projects.print(){
  if [ "$projects_print" = "true" ]; then
    echo -e "projects:"
    _projects
  fi
}

ruby.init(){ ruby_print=$1; }
ruby.print(){
  local ruby_version
  local rails_version
  if [ "$ruby_print" = "true" ]; then 
    if hash rvm 2>/dev/null; then
      if test $(rvm current) == 'system'; then
        ruby_version="ruby-$(ruby --version | awk '{print $2}' | cut -d 'p' -f 1)"
        if hash rails 2>/dev/null; then
          rails_version="rails-$(rails --version | awk '{print $2}')"
          printf "\e[1;34m%s \e[0m%s\n" "  system    " "$ruby_version@$rails_version"
        else
          printf "\e[1;34m%s \e[0m%s\n" "  system    " "$ruby_version"
        fi
      else
        ruby_version=$(rvm current)
        if hash rails 2>/dev/null; then
          rails_version="rails-$(rails --version | awk '{print $2}')"
        else
          rails_version=""
        fi
        printf "\e[1;34m%s \e[0m%s\n" "  rvm domain" "$ruby_version@$rails_version"
      fi
    else
      ruby_version="ruby-$(ruby --version | awk '{print $2}' | cut -d 'p' -f 1)"
      if hash rails 2>/dev/null; then
        rails_version="rails-$(rails --version | awk '{print $2}')"
        printf "\e[0;34m%s \e[0m%s\n" "  system    " "$ruby_version@$rails_version"
      else
        printf "\e[0;34m%s \e[0m%s\n" "  system    " "$ruby_version"
      fi
    fi
  fi 
}

# databases
dbs.methods(){ echo "help|parse_yml|current|has_database|tables|has_tables|records|has_records"; }
dbs.help(){ printf "\e[1;37m%s \e[0m \e[1;36m%s\e[0m\n" "database" "[$(dbs.methods)]"; }
dbs.init(){
  unset MYSQL_DATABASE_DEV
  unset MYSQL_DATABASE_TST
  MYSQL_DATABASE_DEV=$(test -f config/database.yml && dbs.parse_yml config/database.yml | grep development_database | awk -F'"' '{print $2}')
  MYSQL_DATABASE_TST=$(test -f config/database.yml && dbs.parse_yml config/database.yml | grep test_database | awk -F'"' '{print $2}' | awk -F'<' '{print $1}')
}
dbs.parse_yml(){
  local prefix=$2
  local s='[[:space:]]*' w='[a-zA-Z0-9_]*' fs=$(echo @|tr @ '\034')
  sed -ne "s|^\($s\):|\1|" \
       -e "s|^\($s\)\($w\)$s:$s[\"']\(.*\)[\"']$s\$|\1$fs\2$fs\3|p" \
       -e "s|^\($s\)\($w\)$s:$s\(.*\)$s\$|\1$fs\2$fs\3|p"  $1 |
  awk -F$fs '{
      indent = length($1)/2;
      vname[indent] = $2;
      for (i in vname) {if (i > indent) {delete vname[i]}}
      if (length($3) > 0) {
         vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
         printf("%s%s%s=\"%s\"\n", "'$prefix'",vn, $2, $3);
      }
  }'  
}
dbs.current(){
  local env=$1
  if [ -z $env ]; then
    env=$RAILS_ENV
  fi
  if [ "$env" == "development" ] || [ -z $env ]; then
    if [ -z $MYSQL_DATABASE_DEV ]; then
      MYSQL_DATABASE_DEV=$(test -f config/database.yml && dbs.parse_yml config/database.yml | grep development_database | awk -F'"' '{print $2}')
    fi
    echo $MYSQL_DATABASE_DEV
  else
    if [ -z $MYSQL_DATABASE_TST ]; then
      MYSQL_DATABASE_TST=$(test -f config/database.yml && dbs.parse_yml config/database.yml | grep test_database | awk -F'"' '{print $2}' | awk -F'<' '{print $1}')
    fi
    echo $MYSQL_DATABASE_TST
  fi   
}
dbs.has_database(){
  local db=$1
  local res
  mysqlshow -uroot > /dev/null 2>&1
  if [ $? -eq 1 ]; then 
    ansi --no-newline --red-intense "==> "; ansi --white-intense "Database error"
    echo ""
  else  
    res=`mysqlshow -uroot | grep -o $db`
    if [ "$res" == $db ]; then
      echo 'yes'
    else
      echo 'no'  
    fi
  fi
}
dbs.tables(){
  local db=$1
  local s=`mysql -u root -e "SELECT count(*) AS TOTALNUMBEROFTABLES FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '$db';"`
  echo $(echo -n $s | sed 's/[^0-9]*//g' | tr -d '\n')

}
dbs.has_tables(){
  local db=$1
  local tables=$(dbs.tables $db)
  if [ ! "$tables" == '0' ] && [ ! -z $tables ]; then
    echo 'yes'
  else
    echo 'no'  
  fi
}
dbs.records(){
  local db=$1
  local s=`mysql -u root -e "SELECT SUM(TABLE_ROWS) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = '$1';"`
  echo $(echo -n $s | sed 's/[^0-9]*//g' | tr -d '\n')
}
dbs.has_records(){
  local db=$1
  local records=$(dbs.records $1)
  if [ ! "$records" == '' ] && [ ! -z $records ]; then
    echo 'yes'
  else
    echo 'no'  
  fi
}
dbs.print_db(){
  local env=$1
  local db
  local dbs
  local db_lens=()
  db=$(dbs.current development)
  db_lens+=(${#db})
  db=$(dbs.current test)
  db_lens+=(${#db})
  IFS=$'\n'
  major=$(echo "${db_lens[*]}" | sort -nr | head -n1)
  unset IFS
  if [ -z $env ]; then
    env=$RAILS_ENV
  fi
  if [ "$env" == "development" ]; then
    db=$(dbs.current development)
  else  
    db=$(dbs.current test)
  fi
  db=$(printf "%-${major}s" "${db}")
  if [ "$(dbs.has_database $db)" == 'yes' ]; then
    if [ $env == "development" ]; then
      ansi --no-newline "  "; ansi --no-newline --green $db' '; ansi --white --no-newline $(dbs.records $db)' '; ansi --white $(dbs.records $db)
    else
      ansi --no-newline "  "; ansi --no-newline --green $db' '; ansi --white --no-newline $(dbs.records $db)' '; ansi --white $(dbs.records $db)
    fi  
  else  
    ansi --no-newline "  "; ansi --red $db
  fi
}
dbs.print(){
  if test $(site.is_site) = 'yes'; then
    echo -e "dbs:"
    dbs.print_db development
    dbs.print_db test 
  fi  
}

# site
site(){
  local site_methods="+($(site.methods))"
  local param_methods="+($(! test -z "$1" && $1.methods))"
  case $1 in
    --version|-v|v|version)
      site.version
      ;;
    --help|-h|h|help)
      printf "\e[1;37m%s \e[0m\n" "Crafted (c) 2021~22 by Encora - We are stronger together"
      site.version
      printf "\e[1;37m%s \e[0m%s\n" "site" "[$(site.help)]" 
      printf "\e[1;37m%s \e[0m%s\n" "site" "[$(domain.help)]"
      printf "\n"  
      printf "\e[1;37m%s \e[0m%s\n" "site" "[$(projects.help)]"
      printf "::\n"  
      printf "\e[0;32m%s \e[4m%s\e[0m\e[0m\n" "homepage" "https://github.com/enogrob/rails-site-manager"
      printf "\n"
      ;;
    $site_methods)
      if [ -z "$2" ]; then
        $1 
      else  
        case $2 in
          $param_methods)
            $1.$2 ${@:3}
            ;;
          *)
            printf " \e[0;31m%s \e[0m%s\n" "=>" "invalid parameter ${2}"
            ;;  
        esac
      fi  
      ;;
    *)
      if [ -z "$1" ]; then
        site.print
      else   
        printf " \e[0;31m%s \e[0m%s\n" "=>" "invalid parameter ${1}"
      fi  
      ;;
  esac
}
site.methods(){ echo "help|encora|domain|print|projects"; }
site.help(){ printf "\e[1;37m%s   \e[0m \e[1;36m%s\e[0m\n" "site" "[$(site.methods)]"; }
site.is_site(){
  if test -f config/database.yml; then
    echo 'yes'
  else
    echo 'no'  
  fi
}
site.print(){
  if test $(site.is_site) = 'no'; then
    printf "site: \e[4m\e[1;37m$USER@$(hostname)\e[0m\e[0m\n" 
  else
    printf "site: \e[4m\e[1;37m$(basename $PWD)\e[0m\e[0m\n" 
  fi  
  printf "\e[1;34m%s \e[0m%s\n" "  git domain" $(domain) 
  ruby.print
  dbs.print
  projects.print
  printf ""  
}
site.version(){
  printf "\e[0;37m%s \e[0m%s\n" "Site" "$SITE_VERSION"
  printf "\n"
}

domain.encora.init "Roberto Nogueira" "roberto.nogueira@encora.com"
domain.gmail.init "Roberto Nogueira" "enogrob@gmail.com" 

ruby.init $(hash ruby 2>/dev/null && test "$?" -eq 0 && echo true)
projects.init $(test -f $HOME/Projects/project-things-today/.todayrc.sh && echo true)
